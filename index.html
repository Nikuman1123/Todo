<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ToDoApp</title>
    <link rel="stylesheet" href="style.css" />
    <!-- M PLUS Rounded 1cを設定する -->
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>ToDo</h1>
    <input type="text" id="taskInput" placeholder="タスクを入力" />
    <input type="date" id="dueDate" />
    <br />
    <button id="addBtn">Add</button>
    <button id="showAll">Show All</button>
    <button id="showActive">Show Active</button>
    <button id="showCompleted">Show Completed</button>

    <ul id="taskList">
      <!-- JavaScriptでliを追加 -->
    </ul>
    <script>
      const taskInput = document.getElementById('taskInput');
      const taskList = document.getElementById('taskList');

      // ボタンが押された時の処理を関数として記述。
      function addTask() {
        let taskText = taskInput.value;
        taskInput.value = '';

        if (taskText.trim() === '') {
          return; // 入力が空の場合は何もしない
        }

        // liは左右でdivを分割、テキストはspanへ
        const li = document.createElement('li');
        const leftDiv = document.createElement('div');
        leftDiv.classList.add('left');
        const rightDiv = document.createElement('div');
        rightDiv.classList.add('right');
        const textSpan = document.createElement('span');

        // チェックボックスを設定
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            li.style.textDecoration = 'line-through';
          } else {
            li.style.textDecoration = 'none';
          }
        });

        // チェックボックスを追加
        leftDiv.appendChild(checkbox);

        // タスクのテキストを追加
        textSpan.textContent = taskText;

        // 期限日付の取得とチェック
        const dueDateInput = document.getElementById('dueDate');
        const dueDate = dueDateInput.value;
        if (dueDate !== '') {
          const dateObj = new Date(dueDate);
          const isValid = !isNaN(dateObj.getTime());

          if (!isValid) {
            alert('正しい日付を入力してください');
            return;
          }
          // 日付を表示に加える
          textSpan.textContent += `(~${dueDate})`;
        }
        // 日付欄を空欄にする
        dueDateInput.value = '';

        // テキストを追加
        // li.appendChild(textSpan);
        leftDiv.appendChild(textSpan);

        // デリートボタンの設定
        const dlButton = document.createElement('button');
        dlButton.classList.add('delete-btn');
        dlButton.textContent = 'del';

        // デリート押下されたらリストから削除する
        dlButton.addEventListener('click', function () {
          li.remove();
        });

        // デリートボタンを追加
        rightDiv.appendChild(dlButton);

        // leftDivとrightDivをliに追加
        li.appendChild(leftDiv);
        li.appendChild(rightDiv);

        // タスクリストとして追加
        taskList.appendChild(li);

        // タスクを追加したときに入力欄へ自動でフォーカスを戻す
        taskInput.focus();
      }

      // Addボタン押下時
      const addBtn = document.getElementById('addBtn');
      addBtn.addEventListener('click', addTask);

      // 変換途中のエンター押下じゃないかチェック
      let isComposing = false;
      taskInput.addEventListener('compositionstart', () => {
        isComposing = true;
      });
      taskInput.addEventListener('compositionend', () => {
        isComposing = false;
      });

      // 確定後のエンターキー押下を検知する
      taskInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !isComposing) {
          addTask();
        }
      });

      // フィルターボタンを押した時の動作
      function pressFilterButtons(filterType) {
        const allTask = document.querySelectorAll('#taskList li');
        allTask.forEach((li) => {
          const checkbox = li.querySelector('input[type = checkbox]');
          if (filterType === 'all') {
            li.style.display = 'flex';
          } else if (filterType === 'active') {
            li.style.display = checkbox && checkbox.checked ? 'none' : 'flex';
          } else if (filterType === 'completed') {
            li.style.display = checkbox && checkbox.checked ? 'flex' : 'none';
          }
        });
      }

      //押下されたフィルターボタン応じたパラメータを渡す
      // 全表示
      document
        .getElementById('showAll')
        .addEventListener('click', () => pressFilterButtons('all'));
      // 未完了
      document
        .getElementById('showActive')
        .addEventListener('click', () => pressFilterButtons('active'));
      // 完了
      document
        .getElementById('showCompleted')
        .addEventListener('click', () => pressFilterButtons('completed'));
    </script>
  </body>
</html>
