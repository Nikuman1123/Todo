<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ToDoApp</title>
    <link rel="stylesheet" href="style.css" />
    <!-- M PLUS Rounded 1c„ÇíË®≠ÂÆö„Åô„Çã -->
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome CDNÔºàv6Ôºâ -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- <link rel="stylesheet" href="all.css" /> -->
  </head>
  <body>
    <h1>ToDo</h1>
    <input type="text" id="taskInput" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ" />
    <input type="date" id="dueDate" />
    <select id="priority">
      <option value="normal" selected>normal</option>
      <option value="high">high</option>
      <option value="low">low</option>
    </select>
    <button id="addBtn" class="addBtn">Add</button>
    <button id="toggleTheme">‚òÄÔ∏è / üåô</button>
    <button id="clearAll" class="delete-btn hidden">Clear All</button>
    <br />
    <p
      id="errorMsg"
      class="error-message"
      style="color: crimson; display: none"
    ></p>
    <button id="toggleSort" class="sort-button sort-asc">Sort by Date</button>
    <button id="showAll" class="filter-button">All</button>
    <button id="showActive" class="filter-button">Active</button>
    <button id="showCompleted" class="filter-button">Completed</button>
    <button id="clearCompleted" class="delete-btn hidden">
      Clear Completed
    </button>

    <ul id="taskList">
      <!-- JavaScript„Åßli„ÇíËøΩÂä† -->
    </ul>
    <script>
      const taskInput = document.getElementById('taskInput');
      const dueDateInput = document.getElementById('dueDate');
      const taskList = document.getElementById('taskList');
      const clearCompletedBtn = document.getElementById('clearCompleted');
      let weatherList = [];
      let currentFilterType = 'all'; //ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã‰øùÊåÅ

      // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆÂãï‰Ωú
      // ‰øùÂ≠ò„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
      document.addEventListener('DOMContentLoaded', () => {
        // „ÉÜ„Éº„Éû„ÅÆÂæ©ÂÖÉ
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.add(savedTheme);

        // „Éï„Ç£„É´„Çø„ÉºÂàùÊúüÂåñÔºàAll„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâ
        updateFilterButtons('showAll');

        // „Çø„Çπ„ÇØÂÖ•ÂäõÊ¨Ñ„Å´Ëá™Âãï„Éï„Ç©„Éº„Ç´„Çπ;
        taskInput.focus();

        // „ÅäÂ§©Ê∞ó„Å®„Çø„Çπ„ÇØ„ÅÆÂæ©ÂÖÉ
        getWeather().then(() => {
          restoreTasksFromLocalStorage();
          pressFilterButtons('all'); // ‚Üê Ë°®Á§∫Áä∂ÊÖã„ÇÇAll„Å´„Åô„Çã
        });
        sortTasks('asc');

        // „Éá„Éï„Ç©„É´„Éà„ÅßÁèæÂú®Êó•‰ªò„Çí„Çª„ÉÉ„Éà„Åô„Çã
        dueDateInput.value = getTodayDate();
      });

      // Esc„Ç≠„Éº„ÅßÂÖ•Âäõ„Çí„Ç≠„É£„É≥„Çª„É´
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          taskInput.value = '';
          dueDateInput.value = '';
        }
      });

      document.getElementById('clearAll').addEventListener('click', () => {
        const isConfirmed = confirm(
          'Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºüÔºà„ÉÜ„Éº„ÉûË®≠ÂÆö„ÅØÁ∂≠ÊåÅ„Åï„Çå„Åæ„ÅôÔºâ'
        );
        if (!isConfirmed) return;

        clearAllTaskAndSettings();
      });

      // ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„Çø„Çπ„ÇØ„Çí„Åô„Åπ„Å¶ÂâäÈô§
      document
        .getElementById('clearCompleted')
        .addEventListener('click', () => {
          const isConfirmed = confirm(
            'ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü'
          );
          if (!isConfirmed) return;
          let hasRemoved = false;
          const allLis = document.querySelectorAll('#taskList li');
          allLis.forEach((li) => {
            const checkbox = li.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
              // ÂâäÈô§ÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂä†„Åà„Çã
              fadeAndRemove(li, () => {
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂâç„Å†„Åå„ÄÅÂâäÈô§Âá¶ÁêÜ„ÅØÁ¢∫ÂÆö„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß hasRemoved „Çí true „Å´„Åô„Çã
                hasRemoved = true;
                // ‰øùÂ≠òÂá¶ÁêÜ„ÅØ‰∏ãË®ò„ÅÆsetTimeout Âæå„Å´„Åæ„Å®„ÇÅ„Å¶Ë°å„ÅÜ
              });
            }
          });

          // ÊúÄÂæå„Å´„Åæ„Å®„ÇÅ„Å¶‰øùÂ≠ò
          setTimeout(() => {
            if (hasRemoved) {
              saveTasksToLocalStorage();
              // Clear Completed„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
              updateClearCompletedVisibility();
              // Clear All„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
              updateClearAllVisibility();
            }
          }, 300);
        });

      // „ÇΩ„Éº„ÉàÈ†ÜÂàáÊõø
      let isAscending = true; // ÂàùÊúü„ÅØÊòáÈ†ÜÔºàtrueÔºâ
      const toggleSortBtn = document.getElementById('toggleSort');
      toggleSortBtn.addEventListener('click', () => {
        isAscending = !isAscending; //Áä∂ÊÖã„ÇíÂèçËª¢
        const newOrder = isAscending ? 'asc' : 'desc';
        toggleSortBtn.classList.toggle('sort-asc', isAscending);
        toggleSortBtn.classList.toggle('sort-desc', !isAscending);
        // toggleSortBtn.textContent = `Sort by Date ${isAscending ? '‚Üë' : '‚Üì'}`;
        sortTasks(newOrder);
      });

      // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú
      const toggleBtn = document.getElementById('toggleTheme');
      toggleBtn.addEventListener('click', () => {
        // „É¢„Éº„Éâ„ÅÆ‰øùÂ≠ò
        const isDark = document.body.classList.contains('dark');
        const nextTheme = isDark ? 'light' : 'dark';

        document.body.classList.remove('light', 'dark');
        document.body.classList.add(nextTheme);

        localStorage.setItem('theme', nextTheme);
      });

      // Add„Éú„Çø„É≥Êäº‰∏ã
      const addBtn = document.getElementById('addBtn');
      addBtn.addEventListener('click', () => {
        const taskText = taskInput.value;
        const dueDate = dueDateInput.value;

        if (!validateTaskInput(taskText, dueDate)) return;

        addTask(undefined, undefined, false, undefined);
        saveTasksToLocalStorage();
        sortTasks('asc');
      });

      // Â§âÊèõÈÄî‰∏≠„ÅÆ„Ç®„É≥„Çø„ÉºÊäº‰∏ã„Åò„ÇÉ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      let isComposing = false;
      taskInput.addEventListener('compositionstart', () => {
        isComposing = true;
      });
      taskInput.addEventListener('compositionend', () => {
        isComposing = false;
      });

      // Á¢∫ÂÆöÂæå„ÅÆ„Ç®„É≥„Çø„Éº„Ç≠„ÉºÊäº‰∏ã„ÇíÊ§úÁü•„Åô„Çã
      taskInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !isComposing) {
          const taskText = taskInput.value;
          const dueDate = dueDateInput.value;

          if (!validateTaskInput(taskText, dueDate)) return;
          addTask(undefined, undefined, false, undefined);
          saveTasksToLocalStorage();
          sortTasks('asc');
        }
      });

      // ADD„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÊôÇ„ÅÆÂá¶ÁêÜ„ÇíÈñ¢Êï∞„Å®„Åó„Å¶Ë®òËø∞„ÄÇ
      function addTask(taskTextArg, dueDateArg, isDone = false, priorityArg) {
        const taskText =
          typeof taskTextArg === 'string' ? taskTextArg : taskInput.value;
        const dueDate = dueDateArg || document.getElementById('dueDate').value;

        if (taskText.trim() === '') {
          return; // ÂÖ•Âäõ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        }
        taskInput.value = '';
        // „Éá„Éï„Ç©„É´„Éà„ÅßÁèæÂú®Êó•‰ªò„Çí„Çª„ÉÉ„Éà„Åô„Çã„Åü„ÇÅ„ÄÅÊúüÈôêÊó•„ÅÆ„É™„Çª„ÉÉ„Éà„ÇíÂâäÈô§
        // document.getElementById('dueDate').value = '';

        // li„ÅØÂ∑¶Âè≥„Åßdiv„ÇíÂàÜÂâ≤„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÅØspan„Å∏
        const li = document.createElement('li');
        const leftDiv = document.createElement('div');
        leftDiv.classList.add('left');
        const rightDiv = document.createElement('div');
        rightDiv.classList.add('right');
        const textSpan = document.createElement('span');

        // „Çø„Çπ„ÇØ„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíË®≠ÂÆö
        const priorityInput = document.getElementById('priority');
        const priority = priorityArg ?? priorityInput.value;
        li.classList.add(`priority-${priority}`);

        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíË®≠ÂÆö
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isDone; // ‚Üê „Åì„Çå„ÇíËøΩÂä†ÔºÅ
        checkbox.addEventListener('change', () => {
          // if (checkbox.checked) {
          //   li.style.textDecoration = 'line-through';
          // } else {
          //   li.style.textDecoration = 'none';
          // }

          // „ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÅüÊôÇ„ÅÆÂèñ„ÇäÊ∂à„ÅóÁ∑ö„ÇíclassList„ÅßÂÆüÁèæ
          li.classList.toggle('completed', checkbox.checked);

          // LocalStorage‰øùÂ≠ò
          saveTasksToLocalStorage();
          // Clear Completed„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
          updateClearCompletedVisibility();
        });

        // ÂàùÊúüË°®Á§∫„Åß„ÇÇÁ∑ö„ÇíÂºï„Åè
        // li.style.textDecoration = isDone ? 'line-through' : 'none';
        // classList„Çí‰ΩøÁî®„Åó„Å¶„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„ÅÆ„É™„Çπ„Éà„ÇíÂæ©ÂÖÉ„Åô„Çã
        if (isDone) {
          li.classList.add('completed');
        }

        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
        leftDiv.appendChild(checkbox);

        // „Çø„Çπ„ÇØ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†
        textSpan.classList.add('taskText');
        textSpan.textContent = taskText;

        // const dueDateInput = document.getElementById('dueDate');
        // const dueDate = dueDateInput.value;
        if (dueDate !== '') {
          const dateObj = new Date(dueDate);
          const isValid = !isNaN(dateObj.getTime());

          if (!isValid) {
            alert('Ê≠£„Åó„ÅÑÊó•‰ªò„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }

          // Â§©Ê∞ó„Éá„Éº„Çø„ÅÆËøΩÂä†
          const weatherSpan = document.createElement('span');
          weatherSpan.classList.add('weatherInfo');
          if (dueDate) {
            const matched = weatherList.find((item) => item.date === dueDate);
            if (matched) {
              weatherSpan.textContent = `${matched.emoji} ${matched.rain}%`;
              rightDiv.appendChild(weatherSpan);
            }
          }

          // ÊúüÈôêÊó•„ÇíËøΩÂä†
          const dueDateSpan = document.createElement('span');
          dueDateSpan.classList.add('dueDate');
          dueDateSpan.textContent = `Ôºà„Äú${dueDate}Ôºâ`;
          rightDiv.appendChild(dueDateSpan);
        }

        // „ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†
        // li.appendChild(textSpan);
        leftDiv.appendChild(textSpan);

        // „Éá„É™„Éº„Éà„Éú„Çø„É≥„ÅÆË®≠ÂÆö
        const dlButton = document.createElement('button');
        dlButton.classList.add('delete-btn');
        dlButton.textContent = 'del';

        // „Éá„É™„Éº„ÉàÊäº‰∏ã„Åï„Çå„Åü„Çâ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åô„Çã
        dlButton.addEventListener('click', function () {
          //  fading„ÇØ„É©„Çπ„Çí‰ªò‰∏é„Åó„Å¶„Éï„Çß„Éº„ÉâÈñãÂßã„ÄÅ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåÁµÇ„Çè„Çã0.3ÁßíÂæå„Å´ÂâäÈô§
          fadeAndRemove(li, () => {
            // LocalStorage‰øùÂ≠ò
            saveTasksToLocalStorage();
            // Clear Completed„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
            updateClearCompletedVisibility();
            // Clear All„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
            updateClearAllVisibility();
          });
        });

        // „Éá„É™„Éº„Éà„Éú„Çø„É≥„ÇíËøΩÂä†
        rightDiv.appendChild(dlButton);

        // leftDiv„Å®rightDiv„Çíli„Å´ËøΩÂä†
        li.appendChild(leftDiv);
        li.appendChild(rightDiv);

        // „Çø„Çπ„ÇØ„É™„Çπ„Éà„Å®„Åó„Å¶ËøΩÂä†
        taskList.appendChild(li);

        // „Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åü„Å®„Åç„Å´ÂÖ•ÂäõÊ¨Ñ„Å∏Ëá™Âãï„Åß„Éï„Ç©„Éº„Ç´„Çπ„ÇíÊàª„Åô
        taskInput.focus();
        // Clear Completed„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
        updateClearCompletedVisibility();
        // Clear All„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
        updateClearAllVisibility();
        // // LocalStorage‰øùÂ≠ò
        // saveTasksToLocalStorage();
      }

      // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÇíÊäº„Åó„ÅüÊôÇ„ÅÆÂãï‰Ωú
      function pressFilterButtons(filterType) {
        const allTask = document.querySelectorAll('#taskList li');
        allTask.forEach((li) => {
          const checkbox = li.querySelector('input[type = checkbox]');
          li.classList.remove('task-visible', 'task-hidden');
          if (filterType === 'all') {
            // li.style.display = 'flex';
            li.classList.add('task-visible');
          } else if (filterType === 'active') {
            // li.style.display = checkbox && checkbox.checked ? 'none' : 'flex';
            li.classList.add(
              checkbox && checkbox.checked ? 'task-hidden' : 'task-visible'
            );
          } else if (filterType === 'completed') {
            // li.style.display = checkbox && checkbox.checked ? 'flex' : 'none';
            li.classList.add(
              checkbox && checkbox.checked ? 'task-visible' : 'task-hidden'
            );
          }
        });
      }

      function updateFilterButtons(activeButtonId) {
        const buttons = document.querySelectorAll('.filter-button');
        buttons.forEach((btn) => {
          btn.classList.remove('active');
        });
        const activeBtn = document.getElementById(activeButtonId);
        activeBtn.classList.add('active');
      }

      // ==== „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„ÉàÁôªÈå≤ ==== //
      // ÂÖ®Ë°®Á§∫
      document.getElementById('showAll').addEventListener('click', () => {
        currentFilterType = 'all';
        pressFilterButtons('all');
        updateFilterButtons('showAll');
      });
      // Êú™ÂÆå‰∫Ü
      document.getElementById('showActive').addEventListener('click', () => {
        currentFilterType = 'active';
        pressFilterButtons('active');
        updateFilterButtons('showActive');
      });
      // ÂÆå‰∫Ü
      document.getElementById('showCompleted').addEventListener('click', () => {
        currentFilterType = 'completed';
        pressFilterButtons('completed');
        updateFilterButtons('showCompleted');
      });

      // „ÅäÂ§©Ê∞ó„Éá„Éº„Çø„ÅÆAPIÂèñÂæó
      async function getWeather() {
        const url =
          'https://api.open-meteo.com/v1/forecast?latitude=34.6938&longitude=135.5011&daily=weather_code,precipitation_probability_max&timezone=Asia%2FTokyo';
        // 'https://api.open-meteo.com/v1/forecast?latitude=53.3331&longitude=-6.2489&daily=weather_code,precipitation_probability_max&timezone=auto';

        try {
          const response = await fetch(url);
          const weatherData = await response.json();
          console.log('ÂèñÂæóÊàêÂäü:', weatherData); // ‚Üê „Åì„Åì„ÅßÁ¢∫Ë™ç
          editData(weatherData);
        } catch (error) {
          console.error('„Ç®„É©„ÉºÂÜÖÂÆπ:', error); // ‚Üê „Ç®„É©„ÉºË©≥Á¥∞„ÇíÁ¢∫Ë™ç
        }
      }
      // „ÅäÂ§©Ê∞ó„Éá„Éº„Çø„ÅÆÊï¥ÂΩ¢
      function editData(weatherData) {
        // weatherData.daily.time.forEach((date, i) => {
        //   const codes = weatherData.daily.weather_code[i];
        //   const rain = weatherData.daily.precipitation_probability_max[i];
        //   const emoji = getWeatherEmoji(codes);

        //   const weatherObj = {
        //     date,
        //     codes,
        //     emoji,
        //     rain,
        //   };

        //   weatherList.push(weatherObj);
        // });
        weatherList = weatherData.daily.time.map((date, i) => {
          const codes = weatherData.daily.weather_code[i];
          const rain = weatherData.daily.precipitation_probability_max[i];
          const emoji = getWeatherEmoji(codes);

          return { date, codes, emoji, rain };
        });

        console.log('Êï¥ÂΩ¢Âæå„ÅÆÂ§©Ê∞ó„Éá„Éº„Çø:', weatherList);
        // console.log(JSON.stringify(weatherList, null, 2));
      }

      function getWeatherEmoji(codes) {
        const emojiMap = [
          { codes: [0, 1], emoji: '‚òÄÔ∏è' },
          { codes: [2], emoji: '‚òÅÔ∏è' },
          { codes: [3], emoji: '‚õÖÔ∏è' },
          { codes: [45, 48], emoji: 'üò∂‚Äçüå´Ô∏è' },
          { codes: [51, 56], emoji: '‚òîÔ∏èüò∂‚Äçüå´Ô∏è' },
          { codes: [53, 57], emoji: '‚òîÔ∏è‚òîÔ∏èüò∂‚Äçüå´Ô∏è' },
          { codes: [55], emoji: '‚òîÔ∏è‚òîÔ∏è‚òîÔ∏èüò∂‚Äçüå´Ô∏è' },
          { codes: [56, 57], emoji: 'üå´Ô∏èü•∂' },
          { codes: [61], emoji: '‚òîÔ∏è' },
          { codes: [63], emoji: '‚òîÔ∏è‚òîÔ∏è' },
          { codes: [65], emoji: '‚òîÔ∏è‚òîÔ∏è‚òîÔ∏è' },
          { codes: [66, 67], emoji: '‚òîÔ∏èü•∂' },
          { codes: [71, 77, 85], emoji: '‚ùÑÔ∏è' },
          { codes: [73], emoji: '‚ùÑÔ∏è‚ùÑÔ∏è' },
          { codes: [75, 86], emoji: '‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è' },
          { codes: [80], emoji: '‚òîÔ∏è‚è≥' },
          { codes: [81], emoji: '‚òîÔ∏è‚òîÔ∏è‚è≥' },
          { codes: [82], emoji: '‚òîÔ∏è‚òîÔ∏è‚òîÔ∏è‚è≥' },
          { codes: [95], emoji: '‚òîÔ∏è‚ö°Ô∏è' },
          { codes: [96], emoji: 'üßä‚òîÔ∏è‚ö°Ô∏è' },
          { codes: [99], emoji: 'üßäüßä‚òîÔ∏è‚òîÔ∏è‚ö°Ô∏è‚ö°Ô∏è' },
        ];
        const match = emojiMap.find((entry) => entry.codes.includes(codes));
        return match ? match.emoji : '?';
      }
      // LocalStorage‰øùÂ≠òÁî®Èñ¢Êï∞
      function saveTasksToLocalStorage() {
        const allLis = document.querySelectorAll('#taskList li');
        const taskData = [];
        allLis.forEach((li) => {
          const checkbox = li.querySelector('input[type="checkbox"]');
          const text = li.querySelector('.left span').textContent;
          const dueDateSpan = li.querySelector('.dueDate');
          const dueDate = dueDateSpan
            ? dueDateSpan.textContent.replace(/[ÔºàÔºâ„Äú]/g, '')
            : '';
          const isDone = checkbox.checked;

          // li„Åù„Çå„Åû„Çå„ÅÆclassList„Åã„ÇâÂÑ™ÂÖàÂ∫¶„ÇíÊäΩÂá∫„Åô„Çã
          const priorityClass = Array.from(li.classList).find((cls) =>
            cls.startsWith('priority-')
          );
          const priority = priorityClass
            ? priorityClass.replace('priority-', '')
            : 'normal';

          taskData.push({ text, dueDate, isDone, priority });
        });

        localStorage.setItem('tasks', JSON.stringify(taskData));
      }

      // Âæ©ÂÖÉÈñ¢Êï∞Ôºà„Çø„Çπ„ÇØ„ÇíÂÜçË°®Á§∫Ôºâ
      function restoreTasksFromLocalStorage() {
        const saved = localStorage.getItem('tasks');
        if (!saved) return;

        const taskArray = JSON.parse(saved);
        // „Éë„Éº„ÇπÁ¢∫Ë™çÔºà„Åæ„Åö„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÅßÁ¢∫Ë™çÔºâ
        console.log('Âæ©ÂÖÉ„Éá„Éº„ÇøÔºö', taskArray);
        // dueDate „ÇíÂü∫Ê∫ñ„Å´Êó•‰ªòÊòáÈ†Ü„Åß‰∏¶„Å≥Êõø„Åà„Çã
        taskArray.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        renderTasks(taskArray);
        // Clear Completed„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
        updateClearCompletedVisibility();
        // Clear All„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
        updateClearAllVisibility();

        // taskArray.forEach((item) => {
        //   taskInput.value = item.text;
        //   document.getElementById('dueDate').value = item.dueDate;
        //   addTask(item.text, item.dueDate, item.isDone); // Êó¢Â≠ò„ÅÆaddTask()„ÇíÂà©Áî®„Åó„Å¶UI„ÇíÁîüÊàê
        // });
      }

      function renderTasks(taskArray) {
        taskList.innerHTML = '';
        taskArray.forEach((item) => {
          addTask(item.text, item.dueDate, item.isDone, item.priority); // Êó¢Â≠ò„ÅÆaddTask()„ÇíÂà©Áî®„Åó„Å¶UI„ÇíÁîüÊàê
        });
      }

      function sortTasks(order = 'asc') {
        const saved = localStorage.getItem('tasks');
        if (!saved) return;

        const taskArray = JSON.parse(saved);
        if (order === 'asc') {
          taskArray.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        } else {
          taskArray.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
        }
        renderTasks(taskArray);

        // „Éï„Ç£„É´„Çø„ÇíÂÜçÈÅ©Áî®
        pressFilterButtons(currentFilterType);
      }

      function fadeAndRemove(li, callbackAfterRemove) {
        li.classList.add('fading');
        setTimeout(() => {
          li.remove();
          if (typeof callbackAfterRemove === 'function') {
            callbackAfterRemove();
          }
        }, 300);
      }

      function updateClearCompletedVisibility() {
        const completedTasks = document.querySelectorAll(
          '#taskList li.completed'
        );
        if (completedTasks.length > 0) {
          clearCompletedBtn.classList.remove('hidden');
        } else {
          clearCompletedBtn.classList.add('hidden');
        }
        //   clearCompletedBtn.style.display = 'inline-block';
        // } else {
        //   clearCompletedBtn.style.display = 'none';
        // }
      }

      function validateTaskInput(taskText, dueDate) {
        const errorMsg = document.getElementById('errorMsg');
        // ÊúüÈôêÊó•‰ªò„ÅÆÂèñÂæó„Å®„ÉÅ„Çß„ÉÉ„ÇØ
        if (!dueDate) {
          errorMsg.textContent = '‚ö†Ô∏è ÊúüÈôêÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          errorMsg.style.display = 'block';
          return false;
        }

        // ÊúüÈôêÊó•„ÅÆÂÖ•ÂäõÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂàùÊúüÂåñ
        errorMsg.textContent = '';
        errorMsg.style.display = 'none';
        return true;
      }

      // ÊúüÈôêÊó•„ÅÆ„Éá„Éï„Ç©„É´„ÉàÊó•‰ªòÔºàÁèæÂú®Êó•‰ªòÔºâ„ÇíÂèñÂæó„Åô„Çã
      function getTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      //ÂÖ®„Å¶„ÅÆ„Çø„Çπ„ÇØ„Çí„ÄÅË°®Á§∫„Å®„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏‰∏°Êñπ„Åã„ÇâÂâäÈô§„Åô„Çã
      function clearAllTaskAndSettings() {
        // „Çø„Çπ„ÇØ„ÅÆ„Åø localStorage„Åã„ÇâÂâäÈô§
        localStorage.removeItem('tasks');
        // ÁîªÈù¢‰∏ä„ÅÆ„É™„Çπ„Éà„ÇÇÂÖ®ÂâäÈô§

        const allLis = document.querySelectorAll('#taskList li');
        let count = allLis.length;

        allLis.forEach((li) => {
          fadeAndRemove(li, () => {
            count--;
            if (count === 0) {
              //ÂÆåÂÖ®„Å´Ê∂à„Åà„ÅüÂæå„Å´UI„É™„Çª„ÉÉ„Éà
              // „Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã„ÇíÂàùÊúüÂåñÔºàÂÖ®„Å¶Ë°®Á§∫„Å´Êàª„ÅôÔºâ
              currentFilterType = 'all';
              pressFilterButtons('all');
              updateFilterButtons('showAll');

              // „Éú„Çø„É≥„Å™„Å©„ÅÆUIË™øÊï¥
              updateClearCompletedVisibility();
              // Clear All„Éú„Çø„É≥„ÅÆË°®Á§∫Ë®≠ÂÆö
              updateClearAllVisibility();
              //ÊúüÈôêÊó•ÂÖ•Âäõ„ÇíÁèæÂú®Êó•‰ªò„Å´Êàª„Åô
              dueDateInput.value = getTodayDate();
            }
          });
        });
      }

      function updateClearAllVisibility() {
        const allTask = document.querySelectorAll('#taskList li');
        const clearAllBtn = document.getElementById('clearAll');
        if (allTask.length > 0) {
          clearAllBtn.classList.remove('hidden');
        } else {
          clearAllBtn.classList.add('hidden');
        }
      }
    </script>
  </body>
</html>
