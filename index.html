<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ToDoApp</title>
    <link rel="stylesheet" href="style.css" />
    <!-- M PLUS Rounded 1cã‚’è¨­å®šã™ã‚‹ -->
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>ToDo</h1>
    <input type="text" id="taskInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›" />
    <input type="date" id="dueDate" />
    <button id="addBtn" class="addBtn">Add</button>
    <button id="toggleTheme">â˜€ï¸ / ğŸŒ™</button>
    <br />
    <button id="toggleSort" class="sort-button">Sort by Date</button>
    <button id="showAll" class="filter-button">All</button>
    <button id="showActive" class="filter-button">Active</button>
    <button id="showCompleted" class="filter-button">Completed</button>

    <ul id="taskList">
      <!-- JavaScriptã§liã‚’è¿½åŠ  -->
    </ul>
    <script>
      const taskInput = document.getElementById('taskInput');
      const taskList = document.getElementById('taskList');
      let weatherList = [];

      // ã‚½ãƒ¼ãƒˆé †åˆ‡æ›¿
      let isAscending = true;
      const toggleSortBtn = document.getElementById('toggleSort');
      toggleSortBtn.addEventListener('click', () => {
        isAscending = !isAscending; //çŠ¶æ…‹ã‚’åè»¢
        const newOrder = isAscending ? 'asc' : 'desc';
        // toggleSortBtn.textContent = `æ—¥ä»˜ã‚½ãƒ¼ãƒˆï¼š${
        //   isAscending ? 'æ˜‡é †' : 'é™é †'
        // }`;
        sortTasks(newOrder);
      });

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
      const toggleBtn = document.getElementById('toggleTheme');
      toggleBtn.addEventListener('click', () => {
        // document.body.classList.toggle('dark');

        // ãƒ¢ãƒ¼ãƒ‰ã®ä¿å­˜
        const isDark = document.body.classList.contains('dark');
        const nextTheme = isDark ? 'light' : 'dark';

        document.body.classList.remove('light', 'dark');
        document.body.classList.add(nextTheme);

        localStorage.setItem('theme', nextTheme);
      });

      // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
      document.addEventListener('DOMContentLoaded', () => {
        // ãƒ†ãƒ¼ãƒã®å¾©å…ƒ
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.add(savedTheme);

        // ã‚¿ã‚¹ã‚¯å…¥åŠ›æ¬„ã«è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹;
        taskInput.focus();

        // ãŠå¤©æ°—ã¨ã‚¿ã‚¹ã‚¯ã®å¾©å…ƒ
        getWeather().then(() => {
          restoreTasksFromLocalStorage();
        });
      });

      // // ãŠå¤©æ°—æƒ…å ±ã®å–å¾—å‡¦ç†
      // let weatherList = [];
      // getWeather();

      // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã‚’é–¢æ•°ã¨ã—ã¦è¨˜è¿°ã€‚
      function addTask(taskTextArg, dueDateArg, isDone = false) {
        const taskText =
          typeof taskTextArg === 'string' ? taskTextArg : taskInput.value;
        const dueDate = dueDateArg ?? document.getElementById('dueDate').value;

        if (taskText.trim() === '') {
          return; // å…¥åŠ›ãŒç©ºã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        }
        taskInput.value = '';
        document.getElementById('dueDate').value = '';

        // liã¯å·¦å³ã§divã‚’åˆ†å‰²ã€ãƒ†ã‚­ã‚¹ãƒˆã¯spanã¸
        const li = document.createElement('li');
        const leftDiv = document.createElement('div');
        leftDiv.classList.add('left');
        const rightDiv = document.createElement('div');
        rightDiv.classList.add('right');
        const textSpan = document.createElement('span');

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isDone; // â† ã“ã‚Œã‚’è¿½åŠ ï¼
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            li.style.textDecoration = 'line-through';
          } else {
            li.style.textDecoration = 'none';
          }
          // LocalStorageä¿å­˜
          saveTasksToLocalStorage();
        });

        // åˆæœŸè¡¨ç¤ºã§ã‚‚ç·šã‚’å¼•ã
        li.style.textDecoration = isDone ? 'line-through' : 'none';

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
        leftDiv.appendChild(checkbox);

        // ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
        textSpan.textContent = taskText;

        // æœŸé™æ—¥ä»˜ã®å–å¾—ã¨ãƒã‚§ãƒƒã‚¯
        // const dueDateInput = document.getElementById('dueDate');
        // const dueDate = dueDateInput.value;
        if (dueDate !== '') {
          const dateObj = new Date(dueDate);
          const isValid = !isNaN(dateObj.getTime());

          if (!isValid) {
            alert('æ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
          }

          // å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
          const weatherSpan = document.createElement('span');
          weatherSpan.classList.add('weatherInfo');
          if (dueDate) {
            const matched = weatherList.find((item) => item.date === dueDate);
            if (matched) {
              weatherSpan.textContent = `${matched.emoji} ${matched.rain}%`;
              rightDiv.appendChild(weatherSpan);
            }
          }

          // æœŸé™æ—¥ã‚’è¿½åŠ 
          const dueDateSpan = document.createElement('span');
          dueDateSpan.classList.add('dueDate');
          dueDateSpan.textContent = `ï¼ˆã€œ${dueDate}ï¼‰`;
          rightDiv.appendChild(dueDateSpan);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
        // li.appendChild(textSpan);
        leftDiv.appendChild(textSpan);

        // ãƒ‡ãƒªãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¨­å®š
        const dlButton = document.createElement('button');
        dlButton.classList.add('delete-btn');
        dlButton.textContent = 'del';

        // ãƒ‡ãƒªãƒ¼ãƒˆæŠ¼ä¸‹ã•ã‚ŒãŸã‚‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã™ã‚‹
        dlButton.addEventListener('click', function () {
          li.remove();
          // LocalStorageä¿å­˜
          saveTasksToLocalStorage();
        });

        // ãƒ‡ãƒªãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        rightDiv.appendChild(dlButton);

        // leftDivã¨rightDivã‚’liã«è¿½åŠ 
        li.appendChild(leftDiv);
        li.appendChild(rightDiv);

        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã¨ã—ã¦è¿½åŠ 
        taskList.appendChild(li);

        // ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ãŸã¨ãã«å…¥åŠ›æ¬„ã¸è‡ªå‹•ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
        taskInput.focus();

        // // LocalStorageä¿å­˜
        // saveTasksToLocalStorage();
      }

      // Addãƒœã‚¿ãƒ³æŠ¼ä¸‹
      const addBtn = document.getElementById('addBtn');
      // addBtn.addEventListener('click', addTask);
      addBtn.addEventListener('click', () => {
        addTask();
        saveTasksToLocalStorage();
        sortTasks('asc');
      });
      // sortTasks('asc');

      // å¤‰æ›é€”ä¸­ã®ã‚¨ãƒ³ã‚¿ãƒ¼æŠ¼ä¸‹ã˜ã‚ƒãªã„ã‹ãƒã‚§ãƒƒã‚¯
      let isComposing = false;
      taskInput.addEventListener('compositionstart', () => {
        isComposing = true;
      });
      taskInput.addEventListener('compositionend', () => {
        isComposing = false;
      });

      // ç¢ºå®šå¾Œã®ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼æŠ¼ä¸‹ã‚’æ¤œçŸ¥ã™ã‚‹
      taskInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !isComposing) {
          addTask();
          saveTasksToLocalStorage();
          sortTasks('asc');
        }
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‹•ä½œ
      function pressFilterButtons(filterType) {
        const allTask = document.querySelectorAll('#taskList li');
        allTask.forEach((li) => {
          const checkbox = li.querySelector('input[type = checkbox]');
          if (filterType === 'all') {
            li.style.display = 'flex';
          } else if (filterType === 'active') {
            li.style.display = checkbox && checkbox.checked ? 'none' : 'flex';
          } else if (filterType === 'completed') {
            li.style.display = checkbox && checkbox.checked ? 'flex' : 'none';
          }
        });
      }

      function updateFilterButtons(activeButtonId) {
        const buttons = document.querySelectorAll('.filter-button');
        buttons.forEach((btn) => {
          btn.classList.remove('active');
        });
        const activeBtn = document.getElementById(activeButtonId);
        activeBtn.classList.add('active');
      }

      //æŠ¼ä¸‹ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³å¿œã˜ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™
      // å…¨è¡¨ç¤º
      document.getElementById('showAll').addEventListener('click', () => {
        pressFilterButtons('all');
        updateFilterButtons('showAll');
      });
      // æœªå®Œäº†
      document.getElementById('showActive').addEventListener('click', () => {
        pressFilterButtons('active');
        updateFilterButtons('showActive');
      });
      // å®Œäº†
      document.getElementById('showCompleted').addEventListener('click', () => {
        pressFilterButtons('completed');
        updateFilterButtons('showCompleted');
      });

      // ãŠå¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®APIå–å¾—
      async function getWeather() {
        const url =
          'https://api.open-meteo.com/v1/forecast?latitude=34.6938&longitude=135.5011&daily=weather_code,precipitation_probability_max&timezone=Asia%2FTokyo';
        // 'https://api.open-meteo.com/v1/forecast?latitude=53.3331&longitude=-6.2489&daily=weather_code,precipitation_probability_max&timezone=auto';

        try {
          const response = await fetch(url);
          const weatherData = await response.json();
          console.log('å–å¾—æˆåŠŸ:', weatherData); // â† ã“ã“ã§ç¢ºèª
          editData(weatherData);
        } catch (error) {
          console.error('ã‚¨ãƒ©ãƒ¼å†…å®¹:', error); // â† ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª
        }
      }
      // ãŠå¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
      function editData(weatherData) {
        // weatherData.daily.time.forEach((date, i) => {
        //   const codes = weatherData.daily.weather_code[i];
        //   const rain = weatherData.daily.precipitation_probability_max[i];
        //   const emoji = getWeatherEmoji(codes);

        //   const weatherObj = {
        //     date,
        //     codes,
        //     emoji,
        //     rain,
        //   };

        //   weatherList.push(weatherObj);
        // });
        weatherList = weatherData.daily.time.map((date, i) => {
          const codes = weatherData.daily.weather_code[i];
          const rain = weatherData.daily.precipitation_probability_max[i];
          const emoji = getWeatherEmoji(codes);

          return { date, codes, emoji, rain };
        });

        console.log('æ•´å½¢å¾Œã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿:', weatherList);
        // console.log(JSON.stringify(weatherList, null, 2));
      }

      function getWeatherEmoji(codes) {
        const emojiMap = [
          { codes: [0, 1], emoji: 'â˜€ï¸' },
          { codes: [2], emoji: 'â˜ï¸' },
          { codes: [3], emoji: 'â›…ï¸' },
          { codes: [45, 48], emoji: 'ğŸ˜¶â€ğŸŒ«ï¸' },
          { codes: [51, 56], emoji: 'â˜”ï¸ğŸ˜¶â€ğŸŒ«ï¸' },
          { codes: [53, 57], emoji: 'â˜”ï¸â˜”ï¸ğŸ˜¶â€ğŸŒ«ï¸' },
          { codes: [55], emoji: 'â˜”ï¸â˜”ï¸â˜”ï¸ğŸ˜¶â€ğŸŒ«ï¸' },
          { codes: [56, 57], emoji: 'ğŸŒ«ï¸ğŸ¥¶' },
          { codes: [61], emoji: 'â˜”ï¸' },
          { codes: [63], emoji: 'â˜”ï¸â˜”ï¸' },
          { codes: [65], emoji: 'â˜”ï¸â˜”ï¸â˜”ï¸' },
          { codes: [66, 67], emoji: 'â˜”ï¸ğŸ¥¶' },
          { codes: [71, 77, 85], emoji: 'â„ï¸' },
          { codes: [73], emoji: 'â„ï¸â„ï¸' },
          { codes: [75, 86], emoji: 'â„ï¸â„ï¸â„ï¸' },
          { codes: [80], emoji: 'â˜”ï¸â³' },
          { codes: [81], emoji: 'â˜”ï¸â˜”ï¸â³' },
          { codes: [82], emoji: 'â˜”ï¸â˜”ï¸â˜”ï¸â³' },
          { codes: [95], emoji: 'â˜”ï¸âš¡ï¸' },
          { codes: [96], emoji: 'ğŸ§Šâ˜”ï¸âš¡ï¸' },
          { codes: [99], emoji: 'ğŸ§ŠğŸ§Šâ˜”ï¸â˜”ï¸âš¡ï¸âš¡ï¸' },
        ];
        const match = emojiMap.find((entry) => entry.codes.includes(codes));
        return match ? match.emoji : '?';
      }
      // LocalStorageä¿å­˜ç”¨é–¢æ•°
      function saveTasksToLocalStorage() {
        const allLis = document.querySelectorAll('#taskList li');
        const taskData = [];
        allLis.forEach((li) => {
          const checkbox = li.querySelector('input[type="checkbox"]');
          const text = li.querySelector('.left span').textContent;
          const dueDateSpan = li.querySelector('.dueDate');
          const dueDate = dueDateSpan
            ? dueDateSpan.textContent.replace(/[ï¼ˆï¼‰ã€œ]/g, '')
            : '';
          const isDone = checkbox.checked;

          taskData.push({ text, dueDate, isDone });
        });

        localStorage.setItem('tasks', JSON.stringify(taskData));
      }

      // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼†ãƒ‘ãƒ¼ã‚¹ç¢ºèªï¼ˆã¾ãšã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªï¼‰
      const saved = localStorage.getItem('tasks');
      if (saved) {
        const taskArray = JSON.parse(saved);
        console.log('å¾©å…ƒãƒ‡ãƒ¼ã‚¿ï¼š', taskArray);
      }

      // å¾©å…ƒé–¢æ•°ã‚’ä½œã‚‹ï¼ˆã‚¿ã‚¹ã‚¯ã‚’å†è¡¨ç¤ºï¼‰
      function restoreTasksFromLocalStorage() {
        const saved = localStorage.getItem('tasks');
        if (!saved) return;

        const taskArray = JSON.parse(saved);
        // dueDate ã‚’åŸºæº–ã«æ—¥ä»˜æ˜‡é †ã§ä¸¦ã³æ›¿ãˆã‚‹
        taskArray.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        renderTasks(taskArray);

        // taskArray.forEach((item) => {
        //   taskInput.value = item.text;
        //   document.getElementById('dueDate').value = item.dueDate;
        //   addTask(item.text, item.dueDate, item.isDone); // æ—¢å­˜ã®addTask()ã‚’åˆ©ç”¨ã—ã¦UIã‚’ç”Ÿæˆ
        // });
      }

      function renderTasks(taskArray) {
        taskList.innerHTML = '';
        taskArray.forEach((item) => {
          addTask(item.text, item.dueDate, item.isDone); // æ—¢å­˜ã®addTask()ã‚’åˆ©ç”¨ã—ã¦UIã‚’ç”Ÿæˆ
        });
      }

      function sortTasks(order = 'asc') {
        const saved = localStorage.getItem('tasks');
        if (!saved) return;

        const taskArray = JSON.parse(saved);
        if (order === 'asc') {
          taskArray.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        } else {
          taskArray.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
        }
        renderTasks(taskArray);
      }
    </script>
  </body>
</html>
